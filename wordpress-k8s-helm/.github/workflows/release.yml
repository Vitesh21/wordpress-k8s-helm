name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Helm
        uses: azure/setup-helm@v1
        with:
          version: v3.5.4

      - name: Helm package
        run: |
          helm package charts/wordpress
          helm package charts/mysql
          helm package charts/nginx-openresty
          helm package charts/monitoring

      - name: Upload Helm charts
        uses: actions/upload-artifact@v2
        with:
          name: helm-charts
          path: '*.tgz'

      - name: Deploy to Kubernetes
        uses: azure/setup-kubectl@v1
        with:
          version: 'latest'

      - name: Helm install
        run: |
          helm install my-release charts/wordpress --namespace wordpress --create-namespace
          helm install my-release-mysql charts/mysql --namespace mysql --create-namespace
          helm install my-release-nginx charts/nginx-openresty --namespace nginx --create-namespace
          helm install my-release-monitoring charts/monitoring --namespace monitoring --create-namespace

      - name: Notify deployment
        run: echo "Deployment completed successfully!"